<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blog Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    .header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .blogs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 25px;
      margin-top: 20px;
    }
    .blog-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 3px 15px rgba(0,0,0,0.08);
      transition: transform 0.3s ease;
    }
    .blog-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
    .blog-image-container {
      width: 100%;
      height: 220px;
      overflow: hidden;
      background: #f5f5f5;
    }
    .blog-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    .blog-card:hover .blog-image {
      transform: scale(1.05);
    }
    .blog-content { padding: 20px; }
    .blog-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 10px;
      color: #333;
      line-height: 1.4;
    }
    .blog-excerpt {
      color: #666;
      margin-bottom: 15px;
      line-height: 1.6;
      font-size: 0.95rem;
    }
    .blog-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
      font-size: 0.85rem;
    }
    .blog-category {
      background: #e74c3c;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    .blog-date { color: #888; }
    .blog-stats {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }
    .stat-item {
      display: flex;
      align-items: center;
      gap: 5px;
      color: #666;
      font-size: 0.85rem;
    }
    .stat-item i { color: #e74c3c; }
    .blog-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    .btn-view { background: #3498db; color: white; border: none; }
    .btn-view:hover { background: #2980b9; }
    .btn-edit { background: #f39c12; color: white; border: none; }
    .btn-edit:hover { background: #d68910; }
    .btn-delete { background: #e74c3c; color: white; border: none; }
    .btn-delete:hover { background: #c0392b; }
    .loading-spinner { text-align: center; padding: 50px; color: #666; }
    .no-blogs { text-align: center; padding: 50px; color: #888; }
    .no-blogs i { font-size: 3rem; margin-bottom: 20px; color: #ddd; }
    .preview-image {
      max-width: 200px;
      max-height: 150px;
      margin-top: 10px;
      border-radius: 5px;
      display: none;
    }
    @media (max-width: 768px) {
      .blogs-grid { grid-template-columns: 1fr; }
      .blog-image-container { height: 200px; }
    }
    @media (max-width: 480px) {
      .blog-actions { flex-direction: column; }
      .btn { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-2">
            <i class="fas fa-blog text-danger me-2"></i>
            Blog Management
          </h1>
          <p class="text-muted mb-0">Manage and view your blog posts</p>
        </div>
        <div class="d-flex gap-2 align-items-center">
          <button class="btn btn-outline-danger" onclick="refreshBlogs()">
            <i class="fas fa-sync-alt me-2"></i>Refresh
          </button>
          <!-- Login/Logout Button -->
          <button class="btn btn-primary" id="loginBtn" onclick="showLoginModal()">
            <i class="fas fa-sign-in-alt me-2"></i>Login
          </button>
          <button class="btn btn-danger" id="addBlogBtn" onclick="openCreateModal()" style="display: none;">
            <i class="fas fa-plus me-2"></i>Add Blog
          </button>
        </div>
      </div>
    </div>

    <!-- Alert Container -->
    <div id="alertBox" class="mb-4"></div>

    <!-- Blogs Grid -->
    <div class="blogs-grid" id="blogsGrid">
      <div class="loading-spinner">
        <div class="spinner-border text-danger" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Loading blogs...</p>
      </div>
    </div>

    <!-- No Blogs Message Template -->
    <div id="noBlogsTemplate" class="no-blogs" style="display: none;">
      <i class="fas fa-newspaper"></i>
      <h4>No blogs found</h4>
      <p class="text-muted">Start by creating your first blog post!</p>
      <button class="btn btn-danger mt-3" onclick="openCreateModal()">
        <i class="fas fa-plus me-2"></i>Create Blog
      </button>
    </div>
  </div>

  <!-- Create/Edit Modal -->
  <div class="modal fade" id="blogModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="modalTitle">
            <i class="fas fa-plus me-2"></i>Create Blog
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="blogForm" enctype="multipart/form-data">
            <input type="hidden" id="blogId">
            
            <div class="mb-3">
              <label class="form-label">Title *</label>
              <input type="text" class="form-control" id="title" name="title" required placeholder="Enter blog title">
            </div>
            
            <div class="mb-3">
              <label class="form-label">Content *</label>
              <textarea class="form-control" id="content" name="content" rows="6" required placeholder="Write your blog content here..."></textarea>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Category *</label>
              <select class="form-select" id="category" name="category" required>
                <option value="">Select Category</option>
                <option value="Technology">Technology</option>
                <option value="Fashion">Fashion</option>
                <option value="Lifestyle">Lifestyle</option>
                <option value="Health">Health</option>
                <option value="Business">Business</option>
                <option value="Other">Other</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Upload Image</label>
              <input type="file" class="form-control" id="imageFile" name="image" accept="image/*">
              <small class="text-muted">Allowed: JPEG, PNG, GIF, WebP (Max 10MB)</small>
              <img id="previewImage" class="preview-image" alt="Image Preview">
            </div>
            
            <div class="d-flex justify-content-end gap-2 mt-4">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-danger" id="saveBtn" onclick="saveBlog()">
                <i class="fas fa-save me-2"></i>Save Blog
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="fas fa-sign-in-alt me-2"></i>Login</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="loginAlert" class="alert alert-danger" style="display: none;"></div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="loginEmail" value="admin@example.com">
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" class="form-control" id="loginPassword" value="password123">
          </div>
          <div class="text-muted small mb-3">
            <p>Test credentials: admin@example.com / password123</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="login()">Login</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ====================
    // CONFIGURATION
    // ====================
    const API_BASE = "http://localhost:5000/api";
    const BLOGS_API = `${API_BASE}/blogs`;
    const LOGIN_API = `${API_BASE}/auth/login`;  // Your login endpoint
    
    let currentBlogs = [];
    let blogModal = null;
    let loginModal = null;
    let token = localStorage.getItem('token');
    
    // ====================
    // INITIALIZE
    // ====================
    document.addEventListener('DOMContentLoaded', () => {
      blogModal = new bootstrap.Modal(document.getElementById('blogModal'));
      loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
      setupImagePreview();
      checkAuth();
    });
    
    // ====================
    // AUTH FUNCTIONS
    // ====================
    function checkAuth() {
      token = localStorage.getItem('token');
      if (token) {
        // User is logged in
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('addBlogBtn').style.display = 'block';
        document.getElementById('loginBtn').innerHTML = '<i class="fas fa-sign-out-alt me-2"></i>Logout';
        document.getElementById('loginBtn').setAttribute('onclick', 'logout()');
        loadBlogs();
      } else {
        // User is not logged in
        document.getElementById('loginBtn').style.display = 'block';
        document.getElementById('addBlogBtn').style.display = 'none';
        document.getElementById('loginBtn').innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>Login';
        document.getElementById('loginBtn').setAttribute('onclick', 'showLoginModal()');
        loadBlogs(); // Still load blogs (public route)
      }
    }
    
    function showLoginModal() {
      loginModal.show();
    }
    
    async function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      try {
        const response = await fetch(LOGIN_API, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          // Save token and user data
          token = data.token || data.data?.token;
          localStorage.setItem('token', token);
          localStorage.setItem('user', JSON.stringify(data.user || data.data));
          
          showAlert('Login successful!', 'success');
          loginModal.hide();
          checkAuth();
        } else {
          document.getElementById('loginAlert').textContent = data.message || 'Login failed';
          document.getElementById('loginAlert').style.display = 'block';
        }
      } catch (error) {
        document.getElementById('loginAlert').textContent = 'Network error. Check your connection.';
        document.getElementById('loginAlert').style.display = 'block';
      }
    }
    
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        token = null;
        checkAuth();
        showAlert('Logged out successfully', 'info');
      }
    }
    
    // Helper to get auth headers
    function getAuthHeaders() {
      return {
        'Authorization': `Bearer ${token}`
      };
    }
    
    // ====================
    // BLOG FUNCTIONS
    // ====================
    function setupImagePreview() {
      const imageFileInput = document.getElementById('imageFile');
      const previewImage = document.getElementById('previewImage');
      
      imageFileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            previewImage.src = e.target.result;
            previewImage.style.display = 'block';
          }
          reader.readAsDataURL(file);
        } else {
          previewImage.style.display = 'none';
        }
      });
    }
    
    // Show alert message
    function showAlert(message, type = 'info') {
      const alertBox = document.getElementById('alertBox');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} alert-dismissible fade show`;
      alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      alertBox.appendChild(alert);
      
      setTimeout(() => {
        if (alert.parentNode === alertBox) {
          alert.remove();
        }
      }, 5000);
    }
    
    // Load blogs from API
    async function loadBlogs() {
      try {
        const blogsGrid = document.getElementById('blogsGrid');
        blogsGrid.innerHTML = `
          <div class="loading-spinner">
            <div class="spinner-border text-danger" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading blogs...</p>
          </div>
        `;
    
        const response = await fetch(BLOGS_API);
        
        if (response.ok) {
          const result = await response.json();
          currentBlogs = result.data || [];
          console.log(`✅ Loaded ${currentBlogs.length} blogs from API`);
        } else {
          currentBlogs = [];
          showAlert('No blogs found. Create your first blog!', 'info');
        }
      } catch (error) {
        console.error('❌ Error loading blogs:', error);
        currentBlogs = [];
        showAlert('Error loading blogs. Check server connection.', 'danger');
      }
      
      displayBlogs();
    }
    
    // Display blogs in grid
    function displayBlogs() {
      const blogsGrid = document.getElementById('blogsGrid');
      const noBlogsTemplate = document.getElementById('noBlogsTemplate');
      
      if (currentBlogs.length === 0) {
        blogsGrid.innerHTML = '';
        noBlogsTemplate.style.display = 'block';
        return;
      }
      
      noBlogsTemplate.style.display = 'none';
      
      let blogsHTML = '';
      const SERVER_URL = 'http://localhost:5000';
      
      currentBlogs.forEach(blog => {
        // Get image URL
        let imageUrl;
        if (!blog.image) {
          imageUrl = 'https://images.unsplash.com/photo-1499750310107-5fef28a66643?w=400&h=200&fit=crop';
        } else if (typeof blog.image === 'object' && blog.image.url) {
          imageUrl = blog.image.url.startsWith('/') ? SERVER_URL + blog.image.url : blog.image.url;
        } else if (blog.image.startsWith('/')) {
          imageUrl = SERVER_URL + blog.image;
        } else {
          imageUrl = blog.image;
        }
        
        // Format other data
        const title = blog.title || 'Untitled Blog';
        const content = blog.content || '';
        const excerpt = content.length > 150 ? content.substring(0, 150) + '...' : content;
        const category = blog.category || 'General';
        const views = blog.views || 0;
        const authorName = blog.author?.name || 'Unknown';
        
        // Format date
        let formattedDate = 'Recently';
        if (blog.createdAt) {
          const date = new Date(blog.createdAt);
          formattedDate = date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          });
        }
        
        blogsHTML += `
          <div class="blog-card">
            <div class="blog-image-container">
              <img src="${imageUrl}" 
                   alt="${title}" 
                   class="blog-image"
                   onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1499750310107-5fef28a66643?w=400&h=200&fit=crop'">
            </div>
            <div class="blog-content">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <span class="blog-category">${category}</span>
                <span class="blog-date">${formattedDate}</span>
              </div>
              <h3 class="blog-title">${title}</h3>
              <p class="blog-excerpt">${excerpt}</p>
              <small class="text-muted">By: ${authorName}</small>
              
              <div class="blog-stats">
                <div class="stat-item">
                  <i class="fas fa-eye"></i>
                  <span>${views} views</span>
                </div>
              </div>
              
              <div class="blog-actions">
                <button class="btn btn-view" onclick="viewBlog('${blog._id}')">
                  <i class="fas fa-eye me-1"></i> View
                </button>
                ${token ? `
                <button class="btn btn-edit" onclick="editBlog('${blog._id}')">
                  <i class="fas fa-edit me-1"></i> Edit
                </button>
                <button class="btn btn-delete" onclick="deleteBlog('${blog._id}')">
                  <i class="fas fa-trash me-1"></i> Delete
                </button>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      });
      
      blogsGrid.innerHTML = blogsHTML;
    }
    
    // Open create modal
    window.openCreateModal = function() {
      if (!token) {
        showAlert('Please login first to create a blog', 'warning');
        showLoginModal();
        return;
      }
      
      document.getElementById('blogForm').reset();
      document.getElementById('blogId').value = '';
      document.getElementById('previewImage').style.display = 'none';
      document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus me-2"></i>Create Blog';
      document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save me-2"></i>Save Blog';
      blogModal.show();
    };
    
    // Edit blog
    async function editBlog(blogId) {
      if (!token) {
        showAlert('Please login first to edit a blog', 'warning');
        showLoginModal();
        return;
      }
      
      try {
        const response = await fetch(`${BLOGS_API}/${blogId}`, {
          headers: getAuthHeaders()
        });
        
        if (!response.ok) {
          if (response.status === 401) {
            showAlert('Session expired. Please login again.', 'warning');
            logout();
            return;
          }
          showAlert('Blog not found', 'danger');
          return;
        }
        
        const result = await response.json();
        const blog = result.data;
        
        // Populate form
        document.getElementById('blogId').value = blog._id;
        document.getElementById('title').value = blog.title || '';
        document.getElementById('content').value = blog.content || '';
        document.getElementById('category').value = blog.category || '';
        
        // Clear file input
        document.getElementById('imageFile').value = '';
        document.getElementById('previewImage').style.display = 'none';
        
        document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Blog';
        document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save me-2"></i>Update Blog';
        blogModal.show();
      } catch (error) {
        console.error('Error fetching blog:', error);
        showAlert('Error loading blog data', 'danger');
      }
    }
    
    // Save blog (Create or Update)
    async function saveBlog() {
      if (!token) {
        showAlert('Please login first to save a blog', 'warning');
        showLoginModal();
        return;
      }
      
      const blogId = document.getElementById('blogId').value;
      const title = document.getElementById('title').value;
      const content = document.getElementById('content').value;
      const category = document.getElementById('category').value;
      const imageFile = document.getElementById('imageFile').files[0];
      
      if (!title || !content || !category) {
        showAlert('Please fill in all required fields', 'warning');
        return;
      }
      
      const formData = new FormData();
      formData.append('title', title);
      formData.append('content', content);
      formData.append('category', category);
      
      if (imageFile) {
        formData.append('image', imageFile);
      }
      
      try {
        const saveBtn = document.getElementById('saveBtn');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
        saveBtn.disabled = true;
        
        let url = BLOGS_API;
        let method = 'POST';
        
        if (blogId) {
          url = `${BLOGS_API}/${blogId}`;
          method = 'PUT';
        }
        
        const response = await fetch(url, {
          method: method,
          headers: getAuthHeaders(), // ADD TOKEN HERE
          body: formData
          // Don't set Content-Type header for FormData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          showAlert(result.message, 'success');
          blogModal.hide();
          loadBlogs();
        } else {
          if (response.status === 401) {
            showAlert('Session expired. Please login again.', 'warning');
            logout();
          } else {
            showAlert(result.message || 'Error saving blog', 'danger');
          }
        }
      } catch (error) {
        console.error('❌ Save error:', error);
        showAlert('Network error. Check console for details.', 'danger');
      } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
      }
    }
    
    // Delete blog
    async function deleteBlog(blogId) {
      if (!token) {
        showAlert('Please login first to delete a blog', 'warning');
        showLoginModal();
        return;
      }
      
      if (!confirm('Are you sure you want to delete this blog?')) {
        return;
      }
      
      try {
        const response = await fetch(`${BLOGS_API}/${blogId}`, {
          method: 'DELETE',
          headers: getAuthHeaders() // ADD TOKEN HERE
        });
        
        const result = await response.json();
        
        if (response.ok) {
          showAlert(result.message, 'success');
          loadBlogs();
        } else {
          if (response.status === 401) {
            showAlert('Session expired. Please login again.', 'warning');
            logout();
          } else {
            showAlert(result.message || 'Error deleting blog', 'danger');
          }
        }
      } catch (error) {
        console.error('❌ Delete error:', error);
        showAlert('Error deleting blog', 'danger');
      }
    }
    
    // View blog
    function viewBlog(blogId) {
      const blog = currentBlogs.find(b => b._id === blogId);
      if (blog) {
        alert(`Viewing: ${blog.title}\n\n${blog.content.substring(0, 500)}...`);
      }
    }
    
    // Refresh blogs
    window.refreshBlogs = function() {
      loadBlogs();
      showAlert('Blogs refreshed!', 'info');
    };
  </script>
</body>
</html>